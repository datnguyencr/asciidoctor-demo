name: Generate PDF Manuals

on:
  push:
    tags:
      - "v*"

jobs:
  build-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Create build directory
        run: mkdir -p docs/build

      - name: Read apps list and generate PDFs
        run: |
          # Install jq to parse JSON
          sudo apt-get update && sudo apt-get install -y jq

          # Read app names from apps.json
          APPS=$(jq -r '.app[]' apps.json)

          for APP in $APPS; do
            # Normalize app key for filenames (lowercase, no spaces)
            APP_KEY=$(echo $APP | tr '[:upper:]' '[:lower:]' | tr -d ' ')
            
            docker run --rm \
              -v ${{ github.workspace }}/docs:/documents \
              asciidoctor/docker-asciidoctor:main.main \
              asciidoctor-pdf \
              --failure-level=WARN \
              -a app=$APP_KEY \
              -a app-name="$APP" \
              -a version=${VERSION} \
              -o /documents/build/${APP_KEY}-v${VERSION}.pdf \
              /docs/${APP_KEY}/main-${APP_KEY}.adoc
          done

      - name: Upload PDFs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: docs/build/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
