name: Generate PDF Manuals

on:
  push:
    tags:
      - "v*"

jobs:
  build-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Create build directory
        run: mkdir -p docs/build

      - name: Generate PDFs for all apps and platforms
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          APPS=$(jq -r '.app[]' apps.json)
          PLATFORMS=("android" "ios")

          for APP in $APPS; do
            APP_KEY=$(echo "$APP" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
            
            for PLATFORM in "${PLATFORMS[@]}"; do
              docker run --rm \
                -v "${{ github.workspace }}/docs:/documents" \
                asciidoctor/docker-asciidoctor:main.main \
                asciidoctor-pdf \
                --failure-level=WARN \
                -a app="$APP_KEY" \
                -a platform="$PLATFORM" \
                -a app-name="$APP" \
                -a version="${VERSION}" \
                -o "/documents/build/${APP_KEY}-${PLATFORM}-v${VERSION}.pdf" \
                "/documents/apps/${APP_KEY}/main-${PLATFORM}.adoc"
            done
          done

      - name: Upload PDFs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: docs/build/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
